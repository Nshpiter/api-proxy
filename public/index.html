import { serve } from "https://deno.land/std/http/server.ts";
import { serveFile } from "https://deno.land/std/http/file_server.ts";

// --- Configuration ---
const apiMapping = {
  "/discord": "https://discord.com/api",
  "/telegram": "https://api.telegram.org",
  "/openai": "https://api.openai.com",
  "/claude": "https://api.anthropic.com",
  "/gemini": "https://generativelanguage.googleapis.com",
  "/meta": "https://www.meta.ai/api",
  "/groq": "https://api.groq.com/openai",
  "/xai": "https://api.x.ai",
  "/cohere": "https://api.cohere.ai",
  "/huggingface": "https://api-inference.huggingface.co",
  "/together": "https://api.together.xyz",
  "/novita": "https://api.novita.ai",
  "/portkey": "https://api.portkey.ai",
  "/fireworks": "https://api.fireworks.ai",
  "/openrouter": "https://openrouter.ai/api",
};

// 直接从 Deno.env 获取环境变量
const PROXY_DOMAIN = Deno.env.get("PROXY_DOMAIN");
const PROXY_PORT = Deno.env.get("PROXY_PORT") || "8000";

// 检查环境变量
if (!PROXY_DOMAIN) {
  console.error("错误: PROXY_DOMAIN 未设置，请在环境变量中配置！");
  throw new Error("PROXY_DOMAIN 未设置，请在环境变量中配置！"); // 替换为抛出错误
}

// --- 主请求处理函数 ---
async function main(request: Request): Promise<Response> {
  const url = new URL(request.url);
  const pathname = url.pathname;

  // --- 2. 处理特殊路径 ---
  if (pathname === "/" || pathname === "/index.html") {
    return handleDashboardPage(apiMapping,PROXY_DOMAIN); // 返回仪表盘页面
  }

  if (pathname === "/robots.txt") {
    return new Response("User-agent: *\nDisallow: /", {
      status: 200,
      headers: { "Content-Type": "text/plain" },
    });
  }

  // 处理静态文件请求
  if (pathname.startsWith("/public/")) {
    return serveStaticFile(request, `.${pathname}`);
  }

  // --- 3. 代理逻辑 ---
  const [prefix, rest] = extractPrefixAndRest(pathname, Object.keys(apiMapping));
  if (!prefix) {
    return new Response("Not Found", { status: 404 });
  }

  const targetUrl = `${apiMapping[prefix]}${rest}`;

  try {
    const headers = new Headers();
    const allowedHeaders = ["accept", "content-type", "authorization"];
    for (const [key, value] of request.headers.entries()) {
      if (allowedHeaders.includes(key.toLowerCase())) {
        headers.set(key, value);
      }
    }

    const response = await fetch(targetUrl, {
      method: request.method,
      headers: headers,
      body: request.body,
    });

    const responseHeaders = new Headers(response.headers);
    responseHeaders.set("X-Content-Type-Options", "nosniff");
    responseHeaders.set("X-Frame-Options", "DENY");
    responseHeaders.set("Referrer-Policy", "no-referrer");

    return new Response(response.body, {
      status: response.status,
      headers: responseHeaders,
    });
  } catch (error) {
    console.error("代理请求失败:", error);
    return new Response("Internal Server Error", { status: 500 });
  }
}

/** 提取前缀和剩余路径 */
function extractPrefixAndRest(pathname: string, prefixes: string[]): [string | null, string | null] {
  for (const prefix of prefixes) {
    if (pathname.startsWith(prefix)) {
      return [prefix, pathname.slice(prefix.length)];
    }
  }
  return [null, null];
}

/** 生成仪表盘页面 */
async function handleDashboardPage(apiMapping: { [key: string]: string },domain:string): Promise<Response> {
  // Build the HTML content dynamically using apiMapping
  let tableRows = "";
  for (const [proxyPath, targetUrl] of Object.entries(apiMapping)) {
    tableRows += `
      <tr class="service-card">
        <td>
          <div class="flex items-center">
            <i class="fas fa-robot service-icon"></i>
            <code class="code">https://${domain}${proxyPath}</code>
            <button class="copy-button ml-2" onclick="copyText('https://${domain}${proxyPath}')">
              <i class="far fa-copy"></i>
            </button>
          </div>
        </td>
        <td><code class="code">${targetUrl}</code></td>
        <td><span class="status-badge">在线</span></td>
      </tr>
    `;
  }
  const htmlContent = `
  <!DOCTYPE html>
  <html>
  <head>
      <title>API Proxy Service</title>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <!-- 基础样式库 -->
      <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
      <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
      <!-- 图标库 -->
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
      <!-- 动画库 -->
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
      <style>
          body {
              font-family: 'Inter', sans-serif;
              background: #f3f4f6;
          }

          .container {
              max-width: 1200px;
              margin: 2rem auto;
              padding: 0 1rem;
          }

          .table-container {
              background: white;
              border-radius: 8px;
              box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
              overflow: hidden;
              margin-top: 2rem;
          }

          table {
              width: 100%;
              border-collapse: collapse;
          }

          th,
          td {
              padding: 1rem;
              text-align: left;
              border-bottom: 1px solid #e5e7eb;
          }

          th {
              background: #f9fafb;
              font-weight: 600;
              color: #374151;
          }

          td {
              color: #4b5563;
          }

          tr:hover {
              background: #f9fafb;
          }

          .code {
              font-family: monospace;
              background: #f1f5f9;
              padding: 0.2rem 0.4rem;
              border-radius: 4px;
              font-size: 0.9em;
          }

          .footer {
              text-align: center;
              margin-top: 2rem;
              padding: 1rem;
              color: #6b7280;
              display: flex;
              align-items: center;
              justify-content: center;
              gap: 0.25rem;
          }

          .footer a {
              color: #3b82f6;
              text-decoration: none;
              display: inline-flex;
              align-items: center;
          }

          .footer a:hover {
              text-decoration: underline;
          }

          .service-icon {
              width: 24px;
              margin-right: 8px;
              color: #6b7280;
          }

          .copy-button {
              padding: 4px 8px;
              background: #f3f4f6;
              border-radius: 4px;
              border: none;
              cursor: pointer;
              transition: all 0.2s;
          }

          .copy-button:hover {
              background: #e5e7eb;
          }

          .status-badge {
              display: inline-block;
              padding: 2px 8px;
              border-radius: 12px;
              font-size: 12px;
              background: #22c55e;
              color: white;
          }

          .header-card {
              background: linear-gradient(135deg, #4f46e5 0%, #3b82f6 100%);
              color: white;
          }

          @media (max-width: 768px) {
              .table-container {
                  overflow-x: auto;
              }

              table {
                  font-size: 0.9em;
              }
          }
      </style>
  </head>

  <body>
      <div class="container">
          <div class="header-card p-8 rounded-lg shadow-md animate__animated animate__fadeIn">
              <div class="flex items-center mb-4">
                  <i class="fas fa-network-wired text-3xl mr-4"></i>
                  <h1 class="text-3xl font-bold">API Proxy Service</h1>
              </div>
              <p class="opacity-90">
                  <i class="fas fa-shield-alt mr-2"></i>安全可靠的 API 代理服务
              </p>
          </div>

          <div class="table-container animate__animated animate__fadeIn">
              <table>
                  <thead>
                      <tr>
                          <th>代理地址<i class="fas fa-random text-gray-400 ml-2"></i></th>
                          <th>源地址<i class="fas fa-link text-gray-400 ml-2"></i></th>
                          <th>状态<i class="fas fa-signal text-gray-400 ml-2"></i></th>
                      </tr>
                  </thead>
                  <tbody>
                      <!-- API Mappings -->
                      ${tableRows}
                  </tbody>
              </table>
          </div>

          <div class="footer animate__animated animate__fadeIn">
              <i class="fas fa-code"></i>Created by
              <a href="https://linux.do/u/bbb/summary" target="_blank"
                  class="hover:text-blue-700 inline-flex items-center">
                  <img src="https://img.imgdd.com/f210f3.7ac6c2d9-138b-4c9b-affc-e2acbb4b0dc8.png" alt="Linux.do" class="w-4 h-4 mx-1"
                      style="margin-bottom: 1px;">
                  <span><strong>bbb</strong></span>
              </a>
              <span class="mx-2">|</span>
              <span>本站服务器由 <a href="https://yxvm.com/" target="_blank" class="hover:text-blue-700"><strong>YxVM</strong></a> 赞助</span>
          </div>
      </div>
      
      <script>
          function copyText(text) {
              // 创建临时输入框
              const input = document.createElement('textarea');
              input.value = text;
              document.body.appendChild(input);
              // 选择并复制
              input.select();
              input.setSelectionRange(0, 99999);
              try {
                  document.execCommand('copy');
                  const btn = event.currentTarget;
                  btn.innerHTML = '<i class="fas fa-check"></i>';
                  btn.style.background = '#22c55e';
                  btn.style.color = 'white';
                  setTimeout(() => {
                      btn.innerHTML = '<i class="far fa-copy"></i>';
                      btn.style.background = '#f3f4f6';
                      btn.style.color = 'inherit';
                  }, 1000);
              } catch (err) {
                  console.error('复制失败:', err);
              }
              // 移除临时输入框
              document.body.removeChild(input);
          }
      </script>
  </body>

  </html>
  `;
  return new Response(htmlContent, {
    status: 200,
    headers: { "Content-Type": "text/html; charset=utf-8" },
  });
}

async function serveStaticFile(request: Request, filepath: string): Promise<Response> {
  try {
    return await serveFile(request, filepath);
  } catch {
    return new Response("Not Found", { status: 404 });
  }
}

// --- 启动服务器 ---
console.log(`服务器启动于 ${new Date().toISOString()}`);
console.warn(`认证已禁用，访问: https://${PROXY_DOMAIN}:${PROXY_PORT}/`);

serve(
  async (req) => {
    try {
      return await (async () => await main(req))();
    } catch (e) {
      console.error(e);
      return new Response("Internal Server Error", { status: 500 });
    }
  },
  { port: parseInt(PROXY_PORT) },
);
